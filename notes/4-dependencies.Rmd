# Dependencies

How and when to use code from other packages.

* Motivation
* Scoping: how functions find variables
* `NAMESPACE`
* `DESCRIPTION`
* When should you take a dependency?


## Live coding

Going to switch formats to live coding. 

I will regularly check my notes into Github. 

bit.ly/build-tt

`notes/4-dependencies.Rmd`

## Motivation

```{r}
sd
```

```{r}
x <- c(1, 1, 5, 9, 9)
sd(x)
```

```{r}
var <- function(x, na.rm = FALSE){
  100
}
```

What will we get when we run?:
```{r}
sd(x)
```
Answer in:
slido.com #80875 
passcode: tidytools

```{r}
my_sd <- function(x){
  sqrt(var(x))
}
```

What will happen if we run:
```{r}
my_sd(x)
```
Answer in:
slido.com #80875 
passcode: tidytools

What will `f()` return?
```{r}
x <- 1
y <- 1
z <- 1
f <- function() {
  y <- 2
  z <- 2
  g <- function() {
    z <- 3
    c(x, y, z)
  }
  g()
}
f()
```
* 1, 1, 1
* 1, 1, 3
* 1, 2, 2
* 1, 2, 3

slido.com #80875 
passcode: tidytools

### Your Turn: Breakout Rooms

Discuss:  

* What does `f()` return?  
* What are the rules R uses to find a variable?

Timed: 4 minutes

What does `f` return?
```{r}
f()
```

## Scoping Rules

Rules that R uses to find variables.

R looks in the current environment first.
If R can't find it, R looks in the parent environment,
If R can't find it there, R looks in the parent environment,
and so, until it finds it, 
or it reach the empty environment.

The parent environment of a function is where it was 
defined (not called).

These same rules are followed for functions you've defined,
or for function inside packages.

useful functions from rlang:

```{r}
library(rlang)
get_env(my_sd)
env_print(get_env(my_sd))
# Q: for Charlotte why is parent rlang
```

```{r}
get_env(sd)
env_print(get_env(sd))
env_has(get_env(sd), "var")
env_parents(get_env(sd))
```
```{r}
get_env(ggplot2::geom_point)
env_parents(get_env(ggplot2::geom_point))
```
```{r}
get_env(dplyr::mutate)
env_parents(get_env(dplyr::mutate))
```

Always the same. 
Functions used in a package function
will first be looked for in the package namespace,
`namespace:package_name`
(i.e. all functions in the package),
then in the package imports, `imports:package_name`
then in the base package, 
then in the global environment.

To use functions from other packages
in yours, 
you'll need to define the contents of the
import environemnt.

## Adding Dependencies to your Package

**Your Turn** - Breakout Rooms

Get the ns package:
```{r}
usethis::create_from_github("cwickham/ns", fork = FALSE)
```

* `check()`. You should get a `NOTE` about `"Undefined global functions"`

* Fix the problem. Include this in the Roxygen comments
above the `my_sd()` function:
```{r}
#' @importFrom stats var
```

* `check()` to verify the `NOTE` is removed.

Use google doc to report progress.

(~ 5mins)

**Ready to move on?** Indicate in the Google Doc.

While you wait, open the `NAMESPACE` file, 
can you tell how it has changed?







